#
# This is the server logic of a Shiny web application. You can run the 
# application by clicking 'Run App' above.
#
# Find out more about building applications with Shiny here:
# 
#    http://shiny.rstudio.com/
#
library(XML)
library(plyr)
library(dplyr)
library(shiny)
library(leaflet)

# Define server logic required to draw a histogram
shinyServer(function(input, output) {
  
  rv <- reactiveValues(show = NULL)
  
  observeEvent(input$demoMap, {
    rv$show <- "demo"
  })
  
  observeEvent(input$trackMap, {
    rv$show <- "track"
  })
  
  output$path <- renderText({
    if (is.null(rv$show))
    {
      return(HTML(paste("<b>", "Show track: ", "No Selection made!", "</b>")))
    }
    if (identical(rv$show, 'demo'))
    {
      return(HTML(paste("<b>", "Show track: demo", "</b>")))
    }
    if (identical(rv$show, 'track'))
    {
      inFile <- input$tcxfile
      outpath <- ifelse(is.null(inFile),
                        yes = "No Selection made!",
                        no = inFile$name)
      return(HTML(paste("<b>", "Show track: ", outpath, "</b>")))
    }
    
    stop("Unexpected value for lastAction: ", values$lastAction)
  })
  
  output$map <- renderLeaflet({
    if (is.null(rv$show))
    {
      return(NULL)
    }
    if (identical(rv$show, 'demo'))
    {
      isolate({
        track.data <- data.frame(
          time = c("03.03.2013 07:41:04","03.03.2013 07:41:12","03.03.2013 07:41:19","03.03.2013 07:41:25","03.03.2013 07:41:33","03.03.2013 07:41:39","03.03.2013 07:41:44","03.03.2013 07:41:46","03.03.2013 07:41:50","03.03.2013 07:41:54","03.03.2013 07:41:57","03.03.2013 07:42:02","03.03.2013 07:42:09","03.03.2013 07:42:12","03.03.2013 07:42:16","03.03.2013 07:42:22","03.03.2013 07:42:27","03.03.2013 07:42:34","03.03.2013 07:42:39","03.03.2013 07:42:44","03.03.2013 07:42:52","03.03.2013 07:42:59","03.03.2013 07:43:08","03.03.2013 07:43:14","03.03.2013 07:43:20","03.03.2013 07:43:26","03.03.2013 07:43:32","03.03.2013 07:43:38","03.03.2013 07:43:42","03.03.2013 07:43:48","03.03.2013 07:43:55","03.03.2013 07:44:02","03.03.2013 07:44:08","03.03.2013 07:44:15","03.03.2013 07:44:20","03.03.2013 07:44:26","03.03.2013 07:44:32","03.03.2013 07:44:39","03.03.2013 07:44:48","03.03.2013 07:44:54","03.03.2013 07:45:01","03.03.2013 07:45:09","03.03.2013 07:45:15","03.03.2013 07:45:22","03.03.2013 07:45:29","03.03.2013 07:45:37","03.03.2013 07:45:46","03.03.2013 07:45:51","03.03.2013 07:45:57","03.03.2013 07:46:04","03.03.2013 07:46:06","03.03.2013 07:46:12","03.03.2013 07:46:16","03.03.2013 07:46:20","03.03.2013 07:46:26","03.03.2013 07:46:28","03.03.2013 07:46:32","03.03.2013 07:46:37","03.03.2013 07:46:42","03.03.2013 07:46:48","03.03.2013 07:46:55","03.03.2013 07:46:59","03.03.2013 07:47:02","03.03.2013 07:47:10","03.03.2013 07:47:11","03.03.2013 07:47:18","03.03.2013 07:47:26","03.03.2013 07:47:27","03.03.2013 07:47:33","03.03.2013 07:47:41","03.03.2013 07:47:47","03.03.2013 07:47:55","03.03.2013 07:47:59","03.03.2013 07:48:07","03.03.2013 07:48:14","03.03.2013 07:48:21","03.03.2013 07:48:29","03.03.2013 07:48:37","03.03.2013 07:48:42","03.03.2013 07:48:49","03.03.2013 07:48:52","03.03.2013 07:48:59","03.03.2013 07:49:05","03.03.2013 07:49:09","03.03.2013 07:49:13","03.03.2013 07:49:20","03.03.2013 07:49:24","03.03.2013 07:49:28","03.03.2013 07:49:34","03.03.2013 07:49:44","03.03.2013 07:49:52","03.03.2013 07:49:59","03.03.2013 07:50:10","03.03.2013 07:50:13","03.03.2013 07:50:18","03.03.2013 07:50:30","03.03.2013 07:50:40","03.03.2013 07:50:48","03.03.2013 07:50:55","03.03.2013 07:51:03","03.03.2013 07:51:12","03.03.2013 07:51:19","03.03.2013 07:51:27","03.03.2013 07:51:32","03.03.2013 07:51:36","03.03.2013 07:51:44","03.03.2013 07:51:51","03.03.2013 07:52:00","03.03.2013 07:52:08","03.03.2013 07:52:18","03.03.2013 07:52:26","03.03.2013 07:52:34","03.03.2013 07:52:41","03.03.2013 07:52:50","03.03.2013 07:53:00","03.03.2013 07:53:10","03.03.2013 07:53:17","03.03.2013 07:53:26","03.03.2013 07:53:35","03.03.2013 07:53:44","03.03.2013 07:53:52","03.03.2013 07:54:01","03.03.2013 07:54:07","03.03.2013 07:54:15","03.03.2013 07:54:22","03.03.2013 07:54:30","03.03.2013 07:54:37","03.03.2013 07:54:44","03.03.2013 07:54:52","03.03.2013 07:55:00","03.03.2013 07:55:07","03.03.2013 07:55:08","03.03.2013 07:55:11","03.03.2013 07:55:18","03.03.2013 07:55:26","03.03.2013 07:55:28","03.03.2013 07:55:35"),
          lat = c(52.2916407,52.29170046,52.29174966,52.29180079,52.29191856,52.29195954,52.29199785,52.2920178,52.29207597,52.29209164,52.29210556,52.29213674,52.29217445,52.29219516,52.29223983,52.29227345,52.29230396,52.29234008,52.29235793,52.29237679,52.29240789,52.29243044,52.2924581,52.2924664,52.29246564,52.29247914,52.29249557,52.29248215,52.29248685,52.29249967,52.2925151,52.29253706,52.29256019,52.29259506,52.29262364,52.292671,52.29272976,52.29281676,52.29293679,52.29302874,52.29314717,52.29329545,52.29340299,52.29354054,52.29368487,52.29383055,52.29399148,52.29408645,52.29418938,52.29429667,52.29432257,52.29436255,52.29439298,52.29440915,52.29445257,52.29446925,52.29448945,52.29450395,52.29452114,52.29453304,52.29454963,52.29456305,52.29456916,52.29458769,52.29458936,52.29460789,52.29461635,52.29462055,52.29462968,52.2946555,52.29467587,52.29464695,52.29460898,52.29452759,52.29445366,52.29437705,52.29428284,52.29418175,52.29412576,52.29406298,52.29403473,52.29396986,52.29391806,52.29388839,52.29384606,52.29379049,52.293735,52.29369074,52.29362654,52.29350424,52.29340609,52.29332546,52.29319185,52.29315606,52.29309588,52.29295154,52.29283696,52.29274996,52.29267519,52.29257746,52.29247696,52.29244268,52.29243647,52.29243337,52.29242968,52.29242298,52.29239766,52.29237545,52.29236095,52.29234377,52.29233036,52.29231535,52.29231485,52.29231049,52.29226406,52.29222215,52.29218275,52.29208678,52.29197765,52.29185787,52.29175586,52.29164757,52.29158286,52.29149007,52.29141246,52.29131556,52.29123216,52.29116226,52.2911118,52.29109428,52.29107265,52.29107215,52.29107198,52.29105916,52.29105455,52.29105195,52.29105757),
          long = c(9.809471369,9.80922997,9.809020841,9.808841972,9.808677435,9.808517173,9.808365544,9.808302345,9.808179047,9.80805994,9.807967152,9.807830695,9.807622069,9.807536071,9.807418892,9.80723625,9.80707909,9.806870967,9.806733085,9.806592353,9.806346847,9.806129253,9.805842256,9.805663554,9.805485355,9.805280166,9.805079587,9.804899963,9.804759566,9.804570889,9.804365868,9.804122457,9.803937469,9.803731777,9.803587692,9.803428184,9.803271443,9.803096093,9.802869866,9.802737096,9.80260659,9.802481197,9.80239369,9.802307859,9.802225046,9.802129157,9.802045086,9.802013487,9.802030334,9.802172156,9.802214652,9.802392265,9.802507851,9.802624863,9.802800044,9.802862573,9.802975059,9.80315309,9.803316956,9.803487863,9.803625746,9.803696992,9.803757677,9.803892793,9.803909138,9.804022461,9.804162942,9.804180292,9.804249695,9.804400653,9.804528141,9.804647248,9.804678261,9.804720758,9.804747244,9.804782784,9.804824358,9.80486216,9.804884372,9.804906249,9.804917481,9.804942878,9.804954948,9.804968778,9.804986799,9.804999875,9.805013789,9.805038599,9.805037761,9.805071959,9.805103056,9.805123257,9.805159383,9.805170782,9.805185534,9.805194335,9.805199783,9.805210764,9.805214535,9.805264743,9.805363147,9.805466495,9.805573197,9.805635139,9.805715941,9.805871174,9.806002351,9.806148866,9.806280881,9.806441898,9.806571146,9.806693355,9.806807768,9.806986973,9.807159053,9.807345886,9.807464657,9.807515787,9.807525761,9.807538167,9.807545459,9.807544872,9.807552081,9.807555852,9.807564989,9.807577059,9.80759508,9.807672696,9.807797084,9.807940163,9.808051893,9.808070753,9.808123559,9.808238558,9.808388846,9.808427151,9.808547767), 
          alt = c(60.20000076,61.20000076,61.59999847,61.59999847,62.59999847,61.59999847,61.20000076,61.59999847,61.59999847,61.20000076,60.79999924,60.79999924,61.20000076,61.20000076,61.20000076,60.79999924,60.79999924,59.20000076,58.79999924,57.79999924,57.79999924,57.79999924,57.40000153,56.40000153,55,55.40000153,56.40000153,56.79999924,56.79999924,57.40000153,56.79999924,57.40000153,57.79999924,56.40000153,55.79999924,55,55,54.40000153,55.40000153,56.40000153,56.40000153,57.40000153,58.20000076,59.79999924,61.59999847,62.20000076,63.20000076,63.59999847,63.20000076,63.59999847,63.20000076,63.59999847,63.59999847,63.59999847,63.59999847,63.59999847,63.59999847,62.59999847,61.59999847,61.20000076,61.20000076,61.20000076,61.20000076,60.79999924,60.79999924,59.79999924,57.79999924,57.79999924,57.79999924,57.40000153,58.20000076,59.20000076,59.20000076,58.79999924,58.20000076,57.79999924,57.40000153,58.20000076,59.20000076,60.79999924,61.20000076,62.20000076,63.59999847,64.59999847,64,65.59999847,64.59999847,63.20000076,60.79999924,60.20000076,60.79999924,60.20000076,60.79999924,61.20000076,61.59999847,62.20000076,62.20000076,61.59999847,61.20000076,61.59999847,62.59999847,63.20000076,63.59999847,63.59999847,65,68,69.40000153,68,67.40000153,67.40000153,67,66,65.59999847,66,65,65,64,62.59999847,62.59999847,62.20000076,62.59999847,63.20000076,62.59999847,63.20000076,63.20000076,63.20000076,63.20000076,63.20000076,63.59999847,64,63.59999847,63.20000076,63.20000076,62.59999847,62.59999847,62.59999847,63.20000076),
          distance = c(1.549999952,19.29000092,34.58000183,48.00999832,65.5,77.37000275,88.52999878,93.41999817,104.3099976,112.6100006,119.1200027,128.9700012,143.8099976,150.1000061,159.5299988,172.5099945,183.7599945,198.5,208.1199951,217.8899994,234.9900055,250.0299988,269.8299866,282.0799866,294.2600098,308.2999878,322.1400146,334.5599976,344.2000122,357.1300049,371.2000122,387.9299927,400.7900085,415.3900146,425.730011,437.8699951,450.3900146,465.7900085,486.1900024,499.8599854,515.9099731,534.4000244,547.7600098,564.1400146,581.1599731,598.7399902,617.460022,628.2199707,639.8599854,655.2000122,659.2800293,672.1599731,680.7299805,688.9000244,701.7800293,706.4199829,714.25,726.1699829,737.4000244,749.0599976,758.6199951,763.6900024,767.8900146,777.3800049,778.5200195,786.4699707,796.2000122,797.4699707,802.4299927,813.1199951,822.1199951,831.1799927,835.9199829,845.4000244,853.8200073,862.6900024,873.539978,885.0700073,891.4699707,898.6300049,901.7999878,909.2600098,915.0700073,918.539978,923.3599854,929.6500244,935.8900146,941.0200195,948.0499878,961.9199829,973,982.0300293,997.0599976,1001.099976,1007.919983,1023.869995,1036.619995,1046.290039,1054.660034,1066.109985,1079.099976,1087.23999,1094.530029,1098.790039,1104.310059,1114.890015,1124.27002,1134.589966,1143.680054,1154.829956,1163.780029,1172.27002,1180.069946,1192.439941,1205.160034,1218.719971,1227.910034,1239.290039,1251.430054,1264.790039,1276.140015,1288.189941,1295.380005,1305.719971,1314.369995,1325.160034,1334.52002,1343.930054,1354.359985,1364.300049,1372.199951,1373.5,1377.079956,1384.98999,1395.410034,1398.030029,1401.619995),
          speed = c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1.792999983)
        )
      })
    }
    if (identical(rv$show, 'track'))
    {
      xml.path <- input$tcxfile
      
      if (is.null(xml.path))
        return(NULL)
      
      xml.file <- xmlParse(xml.path$datapath)
      xml.track.nodes <- 
        getNodeSet(xml.file, "//ns:Trackpoint", "ns")
      track.data <- ldply(xml.track.nodes, as.data.frame(xmlToList))
      names(track.data) <- c('time', 'lat', 'long', 'alt', 'distance', 'speed')
      
      track.data <- track.data %>%
        mutate_all(funs(as.character)) %>%
        mutate_each_(funs(as.double), vars(-starts_with("time"))) %>%
        mutate(time = as.POSIXct(time, format = "%Y-%m-%dT%H:%M:%S")) %>%
        filter(!is.na(lat) & !is.na(long))
    }
    
    if (!is.null(track.data))
      leaflet() %>% 
        addTiles() %>%
        addPolylines(lat = track.data$lat, lng = track.data$long, popup = paste(as.character(round(track.data$speed * 3.6, 2)), " km/h")) %>%
        addMarkers(lat = track.data$lat[1], lng = track.data$long[1], popup = "Start") %>%
        addMarkers(lat = track.data$lat[length(track.data$lat)], lng = track.data$long[length(track.data$lat)], popup = "Finish")
  })
})
